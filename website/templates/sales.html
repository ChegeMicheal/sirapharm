{% extends "dashboard.html" %} 
{% block title %}
<title>Sales</title>
{% endblock title %} 
{% block content %}
<!-- Sales Management -->
<section id="sales" class="section">
  <h2>Sales</h2>
  <form id="salesForm">
    <label for="barcodeInput">Scan Barcode:</label>
    <input type="text" id="barcodeInput" name="barcodeInput" placeholder="Scan product barcode" autofocus />

    <label for="saleProductName">Product Name:</label>
    <input type="text" id="saleProductName" name="saleProductName" required />

    <label for="saleQuantity">Quantity:</label>
    <input type="number" id="saleQuantity" name="saleQuantity" required />

    <button type="submit">Proceed to checkout</button> <!-- Button to submit the form -->
  </form>
  <div id="saleItemList">
    <ul></ul>
  </div>
</section>
{% endblock content %} 

{% block script %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const salesForm = document.getElementById("salesForm");
    const saleItemList = document.getElementById("saleItemList").querySelector("ul");
    const saleReceiptDiv = document.getElementById("saleReceipt");
    const addSaleItemBtn = document.getElementById("addSaleItemBtn");
    const generateSaleReceiptBtn = document.getElementById("generateSaleReceiptBtn");
    const barcodeInput = document.getElementById("barcodeInput");

    let saleItems = [];
    let totalSaleAmount = 0;

    // Function to fetch product details using barcode
    async function fetchProductDetails(barcode) {
      try {
        const response = await fetch(`/lookup-product?barcode=${barcode}`);
        if (!response.ok) throw new Error('Product not found!');
        const product = await response.json();
        return product;
      } catch (error) {
        console.error("Error fetching product details:", error);
        alert("Product not found!");
      }
    }

    // Handle barcode input
    barcodeInput.addEventListener("change", async () => {
      const barcode = barcodeInput.value;

      if (barcode) {
        const productDetails = await fetchProductDetails(barcode);

        if (productDetails) {
          // Populate product name and unit price fields
          salesForm.saleProductName.value = productDetails.name;
          salesForm.saleUnitPrice.value = productDetails.price;
        }
      }

      // Clear the barcode input after processing
      barcodeInput.value = '';
    });

    // Handle add item button click
    addSaleItemBtn.addEventListener("click", () => {
      const product = salesForm.saleProductName.value.trim();
      const quantity = parseInt(salesForm.saleQuantity.value, 10);
      const unitPrice = parseFloat(salesForm.saleUnitPrice.value);
      const customerName = salesForm.customerName.value.trim();

      if (product && quantity > 0 && unitPrice > 0 && customerName) {
        const item = {
          product,
          quantity,
          unitPrice,
          totalPrice: quantity * unitPrice,
        };

        saleItems.push(item);
        totalSaleAmount += item.totalPrice;

        const listItem = document.createElement("li");
        listItem.textContent = `${item.product} - ${item.quantity} @ ${item.unitPrice.toFixed(2)} each = ${item.totalPrice.toFixed(2)}`;
        
        // Create edit and remove buttons for each item
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => editItem(item, listItem));

        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", () => removeItem(item, listItem));

        listItem.appendChild(editBtn);
        listItem.appendChild(removeBtn);

        saleItemList.appendChild(listItem);

        // Clear input fields after adding the item
        salesForm.saleProductName.value = "";
        salesForm.saleQuantity.value = "";
        salesForm.saleUnitPrice.value = "";
        salesForm.customerName.value = "";
      } else {
        alert("Please fill out all fields with valid data.");
      }
    });

    // Function to edit an item
    function editItem(item, listItem) {
      salesForm.saleProductName.value = item.product;
      salesForm.saleQuantity.value = item.quantity;
      salesForm.saleUnitPrice.value = item.unitPrice;
      salesForm.customerName.value = item.customerName;

      // Remove the item from the saleItems array and update total
      saleItems = saleItems.filter(i => i !== item);
      totalSaleAmount -= item.totalPrice;
      listItem.remove();
    }

    // Function to remove an item
    function removeItem(item, listItem) {
      saleItems = saleItems.filter(i => i !== item);
      totalSaleAmount -= item.totalPrice;
      listItem.remove();
    }

    // Handle generate receipt button click
    generateSaleReceiptBtn.addEventListener("click", () => {
      saleReceiptDiv.innerHTML = ""; // Clear previous receipt

      const receiptHeader = document.createElement("h3");
      receiptHeader.textContent = "Receipt";
      saleReceiptDiv.appendChild(receiptHeader);

      const separator = document.createElement("div");
      separator.classList.add("separator");
      saleReceiptDiv.appendChild(separator);

      saleItems.forEach((item) => {
        const receiptItem = document.createElement("p");
        receiptItem.textContent = `${item.product} - ${item.quantity} @ ${item.unitPrice.toFixed(2)} each = ${item.totalPrice.toFixed(2)}`;
        saleReceiptDiv.appendChild(receiptItem);
      });

      const totalSection = document.createElement("p");
      totalSection.classList.add("total-section");
      totalSection.textContent = `Total: ${totalSaleAmount.toFixed(2)}`;
      saleReceiptDiv.appendChild(totalSection);
    });

    // Print receipt function
    window.printSaleReceipt = () => {
      const receiptContent = saleReceiptDiv.innerHTML;
      const printWindow = window.open("", "", "width=300,height=400"); // Adjust size for smaller receipts
      printWindow.document.write("<html><head><title>Print Receipt</title></head><body>");
      printWindow.document.write(receiptContent);
      printWindow.document.write("</body></html>");
      printWindow.document.close();
      printWindow.print();
    };
  });
</script>
{% endblock script %}